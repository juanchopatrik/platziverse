{"version":3,"sources":["tests/agent-tests.js"],"names":["test","require","sinon","proxyquire","agentFixtures","config","logging","MetricStub","belongsTo","spy","single","Object","assign","id","uuid","AgentStub","db","sandbox","uuidArgs","where","beforeEach","createSandbox","hasMany","create","stub","withArgs","newAgent","returns","Promise","resolve","toJSON","update","findById","byId","findOne","byUuid","findAll","all","connectedArgs","connected","usernameArgs","platzi","setupDatabase","afterEach","resetHistory","t","truthy","Agent","serial","true","called","calledWith","agent","calledOnce","deepEqual","createOrUpdate","calledTwice"],"mappings":"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","sourceRoot":"/home/juancho/Documentos/platzi/platziverse/platziVerse-db","sourcesContent":["'use strict'\n\nconst test = require('ava')\n//generar pruebas ficticias\nconst sinon = require('sinon')\n//reemplazar el require por unas rutas ficticias\nconst proxyquire = require('proxyquire')\n\nconst agentFixtures = require('./fixtures/agent')\n\nlet config = {\n  logging () {}\n}\n\nlet MetricStub = {\n    //cuantas veces fe usada la funcion con sinon.spy\n    belongsTo: sinon.spy()\n}\n//clonamos el objeto single\nlet single = Object.assign({}, agentFixtures.single)\nlet id = 1 \nlet uuid = 'yyy-yyy-yyy'\nlet AgentStub = null\nlet db = null\n//sinons que se reinician\nlet sandbox = null\n\nlet uuidArgs = {\n  where : {uuid}\n}\n\ntest.beforeEach(async () => {\n  //prueba que funciona dentro de un scope y se reinicia\n  sandbox = sinon.createSandbox()\n\n  AgentStub = {\n    hasMany: sandbox.spy()\n  }\n\n  //Model create stub\n  AgentStub.create = sandbox.stub()\n  AgentStub.create.withArgs(newAgent).returns(Promise.resolve({\n    toJSON () {return newAgent}\n  }))\n\n  //Model update Stub\n  AgentStub.update= sandbox.stub()\n  AgentStub.update.withArgs(single,uuidArgs).returns(Promise.resolve(single))\n\n  //Model findById Stub\n  AgentStub.findById = sandbox.stub()\n  AgentStub.findById.withArgs(id).returns(Promise.resolve(agentFixtures.byId(id)))\n\n  // Model findOne Stub\n  AgentStub.findOne= sandbox.stub()\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.byUuid(uuid)))\n\n  //model findAll Stub\nAgentStub.findAll= sandbox.stub()\nAgentStub.findAll.withArgs().returns(Promise.resolve(agentFixtures.all))\nAgentStub.findAll.withArgs(connectedArgs).returns(Promise.resolve(agentFixtures.connected))\nAgentStub.findAll.withArgs(usernameArgs).returns(Promise.resolve(agentFixtures.platzi))\n\n\n  const setupDatabase = proxyquire('../', {\n    './models/agent': () => AgentStub,\n    './models/metric': () => MetricStub\n  })\n  // la base de datos recibe el config\n  db = await setupDatabase(config)\n})\n\n//reiniciar los sandbox y sinon por text\ntest.afterEach(() => {\n  sandbox && sinon.resetHistory()\n})\n\n// test la base de datos recibe un agente\ntest('Agent', t => {\n  t.truthy(db.Agent, 'Agent service should exist')\n})\n\n//test en serie no paralelo\ntest.serial('Setup', t => {\n  t.true(AgentStub.hasMany.called, 'AgentModel.hasMany was executed')\n  t.true(AgentStub.hasMany.calledWith(MetricStub), 'Argument should be the MetricModel')\n  t.true(MetricStub.belongsTo.called, 'MetricModel.belongsTo was executed')\n  t.true(MetricStub.belongsTo.calledWith(AgentStub), 'Argument should be the AgentModel')\n})\n\ntest.serial('Agent#findById', async t =>{\n    let agent = await db.Agent.findById(id)\n    t.true(AgentStub.findById.called, 'findById should be called on model')\n    t.true(AgentStub.findById.calledOnce, 'findById Should be called once')\n    t.true(AgentStub.findById.calledWith(id), 'findById should be called with specific id')\n\n    t.deepEqual(agent, agentFixtures.byId(id), 'should be the same')\n})\n\ntest.serial('Agent#createOrupdate-exists', async t=>{\n  let agent = await db.Agent.createOrUpdate(single)\n\n  t.true(AgentStub.findOne.called,'findOne should be called on model')\n  t.true(AgentStub.findOne.calledTwice,'findOne should be called twice')\n  t.true(AgentStub.findOne.calledWith(uuidArgs),'findOne should be called with uuid args')\n  t.true(AgentStub.update.called, 'agent.update called on model')\n  t.true(AgentStub.update.calledOnce, 'agent.update should be called once')\n  t.true(AgentStub.update.calledWith(single), 'agent.update should be called with specified args')\n\n  t.deepEqual(agent, single, 'agent Should be the same')\n})\n\ntest.serial('Agent#creteOrUpdate - new', async t=>{\n  let agent = await db.Agent.createOrUpdate(newAgent)\n\n  t.true(AgentStub.findOne.called, 'findOne should be called on model')\n  t.true(AgentStub.findOne.calledOnce, 'findOne should be called once')\n  t.true(AgentStub.findOne.calledWith({where: { uuid: newAgent.uuid }}), 'findOne should be called with uuid args')\n  t.true(AgentStub.create.called, 'create should be called on model')\n  t.true(AgentStub.create.calledOnce, 'create should be called once')\n  t.true(AgentStub.create.calledWith(newAgent), 'create should be called with specified args')\n\n  t.deepEqual(agent, newAgent, 'AgentShould be the same')\n})"]}